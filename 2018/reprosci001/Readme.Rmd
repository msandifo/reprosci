---
title: "001-Gladstone LNG"
output: github_document
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,  message=FALSE, warning=FALSE)
 source('./src/themes001.R')
source('./src/functions001.R')

  
```

## Summary

Amongst the many factors that caused Australian east coast electricity wholesale prices to double between 2015 and 2016, is the opening of the east coast gas market to internatinal exports. 
Here I explore time series of Gladstone Port Authority LNG export volumes, and NEM market dispatch prices to illustrate the correlations.
LNG exports are expresed in annualised tonneage. NEM market prices are in AUD$ per megawatt hour.

## Data Sources

LNG epxorts  are soruced from Gladstone Port authority - http://content1.gpcl.com.au/viewcontent/CargoComparisonsSelection/CargoComparisonsSelection.aspx, 

NEM electricity prices are sourced from AEMO dispatch files by region id




## Code

AEMO data files  are downloaded  to a local directory set by 
``` local.path```
By dafult ``` local.path=NULL``` in which case data is downloaded via rappdirs::user_cache_dir() to a folder in the users cache directory (for MACOSX, ~/Library/cache), aeomo to ```file.path(local.path, aemo)```.

```{r echo=T, eval=F}
download_aemo_aggregated(year=2010:2018, months=1:12, local.path=local.path)
download_aemo_current( local.path=local.path )
```

The code is organised and run/update via a drake plan.
```{r drake_plan, echo=TRUE, cache=TRUE}
config <- drake::drake_config(reproplan001)
graph <- drake::drake_graph_info(
  config, group = "status", clusters = "imported")
drake::render_drake_graph(graph, file="figs/rmd_render_drake.png")
#drake::vis_drake_graph(config, file="test_vis_drake.png")
```

<img src="./figs/rmd_render_drake.png" alt="hist1" align="center" style = "border: none; float: center;" width = "1000px">



The drake make file
```{r echo=T, eval=F}
drake::make( reproplan001, force=T)
```

AEMO data files for each of the five region are aggregated across the NEM as monthly ``` NEM.month``` and annual ```NEM.year``` timeseries. 

Gladstone cargo exports are read from html tables ```lng``` and stored to disk as   ```file.path(local.path, lng, lng.Rdata)``` - see code details.


## Output

The code generates three charts :

```{r repo001  }
drake::readd(reprosci001.plot)
```




```{r repo002, echo=FALSE}
drake::readd(reprosci002.plot)
```

```{r repo003, echo=FALSE}
drake::readd(reprosci003.plot)
```

## Code details

We sue rvest to download the data from ladstine prot authority

```{r code1, echo=T}

 read_gladstone_ports<- function(year=NULL, 
                                 month=NULL,
                                 fuel="Liquefied Natural Gas",
                                 country="Total"){
  args <- as.list(match.call())
   if (is.null(year)) year <- lubridate::year(Sys.Date())
  if (is.null(month)) {
    current.month <- lubridate::month(Sys.Date())
    #current month not posted (usually not posted until second week of current month)
 
    if (current.month>1 ) month <- current.month <- 1  else if (is.null(args$year)) {
      month=12
      year<-year-1
      }
  }
   if (month>= 10) yearmonth= paste(year,month, sep="") else 
     yearmonth= paste(year,month, sep="0")
   message(paste(fuel, month, year))
   url<-paste0("http://content1.gpcl.com.au/viewcontent/CargoComparisonsSelection/CargoOriginDestination.aspx?View=C&Durat=M&Key=",yearmonth)
   wg <- rvest::html_session(url )
   batches <- rvest::read_html(wg) %>%
     rvest::html_nodes("#MainContent_pnlResults")   #class(batches)
   table <- batches %>%
     rvest::html_nodes("td") %>%
     rvest::html_text()
   lng.ind <- which( table==fuel)
   t.ind <-which(str_detect(table,country))
   t.lng.ind  <- t.ind[t.ind>lng.ind][1]
   value <- table[t.lng.ind+1] %>% str_replace_all(",","") %>%as.numeric()
   mdays <- lubridate::days_in_month(lubridate::ymd(paste(year,month, "01", sep="-")))
   if(country=="Total"){
     ships <- table[t.lng.ind+2] %>% str_replace_all(",","") %>%as.numeric()
     return(data.frame(year=year, 
                       month=month, 
                       date=lubridate::ymd(paste(year,month, "15", sep="-")),
                       tonnes=value, 
                       shipments=ships, 
                       mdays=mdays))
   } else 
     return(data.frame(year=year, 
                       month=month,  
                       date=lubridate::ymd(paste(year,month, "15", sep="-")),
                       tonnes=value,
                       mdays=mdays))
 }
```

## Errata
